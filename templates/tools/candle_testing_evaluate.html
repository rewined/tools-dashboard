{% extends "toolkit_base.html" %}

{% block title %}Evaluate Trial - Candle Testing{% endblock %}
{% block nav_title %}Candle Test Evaluation{% endblock %}

{% block content %}
<div class="evaluation-container">
    <div class="test-info">
        <h2>Test {{ test.id }}</h2>
        <div class="test-details">
            <div class="detail-item">
                <span class="label">Trial:</span> 
                <span class="value">{{ trial.trial_number }} - {{ trial.wick }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Vessel:</span> 
                <span class="value">{{ test.vessel }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Wax:</span> 
                <span class="value">{{ test.wax }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Fragrance:</span> 
                <span class="value">{{ test.fragrance }} @ {{ test.blend_percentage }}%</span>
            </div>
        </div>
    </div>

    <div class="evaluation-form">
        <div class="time-tabs">
            <button class="time-tab active" data-hour="1hr">1 Hour</button>
            <button class="time-tab" data-hour="2hr">2 Hour</button>
            <button class="time-tab" data-hour="4hr">4 Hour</button>
            <button class="time-tab extinguish-tab" data-hour="extinguish">Post-Extinguish</button>
        </div>

        <!-- 1 Hour Form -->
        <div class="time-form active" id="form-1hr">
            <h3>1 Hour Reading</h3>
            <form class="evaluation-fields">
                <div class="form-group">
                    <label>Full Melt Pool Achieved?</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="full_melt_pool_1hr" value="true">
                            <span>Yes</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="full_melt_pool_1hr" value="false">
                            <span>No</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="melt_pool_depth_1hr">Melt Pool Depth (inches)</label>
                    <input type="number" id="melt_pool_depth_1hr" step="0.01" min="0" max="2" 
                           placeholder="e.g., 0.25" class="form-control">
                </div>

                <div class="form-group">
                    <label for="external_temp_1hr">External Temperature (¬∞F)</label>
                    <input type="number" id="external_temp_1hr" step="0.1" min="50" max="200" 
                           placeholder="e.g., 145.5" class="form-control">
                </div>

                <div class="form-group">
                    <label for="flame_height_1hr">Flame Height (inches)</label>
                    <input type="number" id="flame_height_1hr" step="0.01" min="0" max="3" 
                           placeholder="e.g., 1.25" class="form-control">
                </div>

                <button type="button" onclick="saveEvaluation('1hr')" class="btn btn-primary">Save 1 Hour Reading</button>
            </form>
        </div>

        <!-- 2 Hour Form -->
        <div class="time-form" id="form-2hr">
            <h3>2 Hour Reading</h3>
            <form class="evaluation-fields">
                <div class="form-group">
                    <label>Full Melt Pool Achieved?</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="full_melt_pool_2hr" value="true">
                            <span>Yes</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="full_melt_pool_2hr" value="false">
                            <span>No</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="melt_pool_depth_2hr">Melt Pool Depth (inches)</label>
                    <input type="number" id="melt_pool_depth_2hr" step="0.01" min="0" max="2" 
                           placeholder="e.g., 0.25" class="form-control">
                </div>

                <div class="form-group">
                    <label for="external_temp_2hr">External Temperature (¬∞F)</label>
                    <input type="number" id="external_temp_2hr" step="0.1" min="50" max="200" 
                           placeholder="e.g., 145.5" class="form-control">
                </div>

                <div class="form-group">
                    <label for="flame_height_2hr">Flame Height (inches)</label>
                    <input type="number" id="flame_height_2hr" step="0.01" min="0" max="3" 
                           placeholder="e.g., 1.25" class="form-control">
                </div>

                <button type="button" onclick="saveEvaluation('2hr')" class="btn btn-primary">Save 2 Hour Reading</button>
            </form>
        </div>

        <!-- 4 Hour Form -->
        <div class="time-form" id="form-4hr">
            <h3>4 Hour Reading</h3>
            <form class="evaluation-fields">
                <div class="form-group">
                    <label>Full Melt Pool Achieved?</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="full_melt_pool_4hr" value="true">
                            <span>Yes</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="full_melt_pool_4hr" value="false">
                            <span>No</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="melt_pool_depth_4hr">Melt Pool Depth (inches)</label>
                    <input type="number" id="melt_pool_depth_4hr" step="0.01" min="0" max="2" 
                           placeholder="e.g., 0.25" class="form-control">
                </div>

                <div class="form-group">
                    <label for="external_temp_4hr">External Temperature (¬∞F)</label>
                    <input type="number" id="external_temp_4hr" step="0.1" min="50" max="200" 
                           placeholder="e.g., 145.5" class="form-control">
                </div>

                <div class="form-group">
                    <label for="flame_height_4hr">Flame Height (inches)</label>
                    <input type="number" id="flame_height_4hr" step="0.01" min="0" max="3" 
                           placeholder="e.g., 1.25" class="form-control">
                </div>

                <button type="button" onclick="saveEvaluation('4hr')" class="btn btn-primary">Save 4 Hour Reading</button>
            </form>
        </div>

        <!-- Post-Extinguish Form -->
        <div class="time-form" id="form-extinguish">
            <h3>Post-Extinguish Measurements</h3>
            <p class="help-text">Extinguish candle after 4-hour reading and measure:</p>
            <form class="evaluation-fields">
                <div class="form-group">
                    <label for="after_glow">After Glow Duration (seconds)</label>
                    <input type="number" id="after_glow" step="1" min="0" max="300" 
                           placeholder="e.g., 15" class="form-control">
                </div>

                <div class="form-group">
                    <label for="after_smoke">After Smoke Duration (seconds)</label>
                    <input type="number" id="after_smoke" step="1" min="0" max="300" 
                           placeholder="e.g., 30" class="form-control">
                </div>

                <button type="button" onclick="saveExtinguishData()" class="btn btn-primary">Save Post-Extinguish Data</button>
            </form>
        </div>
    </div>

    <div class="evaluation-status">
        <h4>Evaluation Progress</h4>
        <div class="progress-indicators">
            <div class="progress-item" id="status-1hr">
                <span class="icon">‚è±Ô∏è</span>
                <span class="label">1 Hour</span>
                <span class="status">Pending</span>
            </div>
            <div class="progress-item" id="status-2hr">
                <span class="icon">‚è±Ô∏è</span>
                <span class="label">2 Hour</span>
                <span class="status">Pending</span>
            </div>
            <div class="progress-item" id="status-4hr">
                <span class="icon">‚è±Ô∏è</span>
                <span class="label">4 Hour</span>
                <span class="status">Pending</span>
            </div>
            <div class="progress-item" id="status-extinguish">
                <span class="icon">üî•</span>
                <span class="label">Post-Extinguish</span>
                <span class="status">Pending</span>
            </div>
        </div>
    </div>
</div>

<style>
.evaluation-container {
    padding: 1rem;
    max-width: 800px;
    margin: 0 auto;
}

.test-info {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.test-info h2 {
    margin-bottom: 1rem;
    color: #2d3748;
}

.test-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-item .label {
    font-size: 0.875rem;
    color: #718096;
    font-weight: 600;
}

.detail-item .value {
    font-size: 1rem;
    color: #2d3748;
}

.evaluation-form {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e2e8f0;
}

.time-tab {
    padding: 0.75rem 1.5rem;
    border: none;
    background: none;
    color: #718096;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}

.time-tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
}

.time-tab:hover {
    color: #4a5568;
}

.extinguish-tab {
    margin-left: auto;
    background: #fef3c7;
    border-radius: 6px 6px 0 0;
}

.time-form {
    display: none;
}

.time-form.active {
    display: block;
}

.time-form h3 {
    margin-bottom: 1rem;
    color: #2d3748;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-weight: 600;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 1rem;
}

.radio-group {
    display: flex;
    gap: 1.5rem;
}

.radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.radio-label input {
    margin-right: 0.5rem;
}

.radio-label span {
    color: #4a5568;
}

.evaluation-status {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.evaluation-status h4 {
    margin-bottom: 1rem;
    color: #2d3748;
}

.progress-indicators {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.progress-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    background: #f7fafc;
    border-radius: 8px;
    text-align: center;
}

.progress-item .icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.progress-item .label {
    font-size: 0.875rem;
    color: #4a5568;
    font-weight: 600;
}

.progress-item .status {
    font-size: 0.75rem;
    color: #718096;
    margin-top: 0.25rem;
}

.progress-item.completed {
    background: #d1fae5;
}

.progress-item.completed .status {
    color: #065f46;
}

.help-text {
    color: #718096;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

@media (max-width: 640px) {
    .evaluation-container {
        padding: 0.5rem;
    }
    
    .time-tabs {
        flex-wrap: wrap;
    }
    
    .time-tab {
        flex: 1;
        min-width: 100px;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }
}
</style>

<script>
const testId = '{{ test.id }}';
const trialId = '{{ trial.id }}';
const evaluationData = {{ evaluation_data | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    // Set up tab switching
    document.querySelectorAll('.time-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            switchTab(this.dataset.hour);
        });
    });
    
    // Load existing data
    loadExistingData();
    updateProgressIndicators();
});

function switchTab(hour) {
    // Update active tab
    document.querySelectorAll('.time-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-hour="${hour}"]`).classList.add('active');
    
    // Update active form
    document.querySelectorAll('.time-form').forEach(form => {
        form.classList.remove('active');
    });
    document.getElementById(`form-${hour}`).classList.add('active');
}

function loadExistingData() {
    // Load 1hr data
    if (evaluationData['1hr']) {
        const data = evaluationData['1hr'];
        document.querySelector(`input[name="full_melt_pool_1hr"][value="${data.full_melt_pool}"]`).checked = true;
        document.getElementById('melt_pool_depth_1hr').value = data.melt_pool_depth;
        document.getElementById('external_temp_1hr').value = data.external_temp;
        document.getElementById('flame_height_1hr').value = data.flame_height;
    }
    
    // Load 2hr data
    if (evaluationData['2hr']) {
        const data = evaluationData['2hr'];
        document.querySelector(`input[name="full_melt_pool_2hr"][value="${data.full_melt_pool}"]`).checked = true;
        document.getElementById('melt_pool_depth_2hr').value = data.melt_pool_depth;
        document.getElementById('external_temp_2hr').value = data.external_temp;
        document.getElementById('flame_height_2hr').value = data.flame_height;
    }
    
    // Load 4hr data
    if (evaluationData['4hr']) {
        const data = evaluationData['4hr'];
        document.querySelector(`input[name="full_melt_pool_4hr"][value="${data.full_melt_pool}"]`).checked = true;
        document.getElementById('melt_pool_depth_4hr').value = data.melt_pool_depth;
        document.getElementById('external_temp_4hr').value = data.external_temp;
        document.getElementById('flame_height_4hr').value = data.flame_height;
    }
    
    // Load post-extinguish data
    if (evaluationData['post_extinguish']) {
        const data = evaluationData['post_extinguish'];
        document.getElementById('after_glow').value = data.after_glow;
        document.getElementById('after_smoke').value = data.after_smoke;
    }
}

function updateProgressIndicators() {
    if (evaluationData['1hr']) {
        const item = document.getElementById('status-1hr');
        item.classList.add('completed');
        item.querySelector('.status').textContent = 'Completed';
    }
    
    if (evaluationData['2hr']) {
        const item = document.getElementById('status-2hr');
        item.classList.add('completed');
        item.querySelector('.status').textContent = 'Completed';
    }
    
    if (evaluationData['4hr']) {
        const item = document.getElementById('status-4hr');
        item.classList.add('completed');
        item.querySelector('.status').textContent = 'Completed';
    }
    
    if (evaluationData['post_extinguish']) {
        const item = document.getElementById('status-extinguish');
        item.classList.add('completed');
        item.querySelector('.status').textContent = 'Completed';
    }
}

function saveEvaluation(hour) {
    const fullMeltPool = document.querySelector(`input[name="full_melt_pool_${hour}"]:checked`);
    const meltPoolDepth = document.getElementById(`melt_pool_depth_${hour}`).value;
    const externalTemp = document.getElementById(`external_temp_${hour}`).value;
    const flameHeight = document.getElementById(`flame_height_${hour}`).value;
    
    if (!fullMeltPool || !meltPoolDepth || !externalTemp || !flameHeight) {
        alert('Please fill in all fields');
        return;
    }
    
    const data = {
        test_id: testId,
        trial_id: trialId,
        hour: hour,
        full_melt_pool: fullMeltPool.value === 'true',
        melt_pool_depth: parseFloat(meltPoolDepth),
        external_temp: parseFloat(externalTemp),
        flame_height: parseFloat(flameHeight)
    };
    
    fetch('/candle-testing/api/save-evaluation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`${hour} reading saved successfully!`);
            evaluationData[hour] = {
                full_melt_pool: data.full_melt_pool,
                melt_pool_depth: data.melt_pool_depth,
                external_temp: data.external_temp,
                flame_height: data.flame_height
            };
            updateProgressIndicators();
        } else {
            alert('Error saving evaluation: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function saveExtinguishData() {
    const afterGlow = document.getElementById('after_glow').value;
    const afterSmoke = document.getElementById('after_smoke').value;
    
    if (!afterGlow || !afterSmoke) {
        alert('Please fill in all fields');
        return;
    }
    
    const data = {
        test_id: testId,
        trial_id: trialId,
        hour: 'post_extinguish',
        after_glow: parseInt(afterGlow),
        after_smoke: parseInt(afterSmoke)
    };
    
    fetch('/candle-testing/api/save-evaluation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Post-extinguish data saved successfully!');
            evaluationData['post_extinguish'] = {
                after_glow: data.after_glow,
                after_smoke: data.after_smoke
            };
            updateProgressIndicators();
        } else {
            alert('Error saving data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}
</script>
{% endblock %}